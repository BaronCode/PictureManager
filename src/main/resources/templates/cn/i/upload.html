<!DOCTYPE html>
<html lang="en">
    <head>
        <title>PicMan Upload</title>
        <meta charset="utf-8">
        <meta name="author" content="Angelo">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/footer.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
        <link rel="shortcut icon" th:href="@{/imgs/logo.png}" type="image/x-icon">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1/dist/fancybox/fancybox.css">

        <script>
            $(document).ready(function() {

                let droppedFiles = null;

                const dropzone = $("#dropzone");
                const fileInput = $("#fileInput");
                const form = $("#uploadForm");
                const selection = $("#selection");
                const accept = [".jpg", ".jpeg", ".heic", ".png", ".tiff", ".cr2", ".heif", ".zip"];

                dropzone.on("click", function() {
                    fileInput.click()

                });

                fileInput.on("change", () => {
                    droppedFiles = null; // picker wins
                    selection.text("Selected file " + fileInput.prop("files")[0].name)
                });

                /* DRAG & DROP */
                dropzone.on("dragover", e => {
                    e.preventDefault();
                });

                dropzone.on("drop", e => {
                    e.preventDefault();
                    droppedFiles = e.originalEvent.dataTransfer.files;
                    selection.text("Selected file " + droppedFiles[0].name)
                });

                /* SUBMIT */
                (form).on("submit", e => {
                    console.log("fires")
                    e.preventDefault();
                    $("#overlay").removeClass("n")
                    $("#submit-def").on("click", function () {
                        const fd = new FormData();
                        if (droppedFiles) {
                            if (accept.some(s => droppedFiles[0].name.toLowerCase().endsWith(s))) {
                                fd.append("file", droppedFiles[0]);
                            }
                        } else if (fileInput.prop("files").length > 0) {
                            fd.append("file", fileInput.prop("files")[0]);
                        } else {
                            alert("No file selected");
                            return;
                        }
                        fd.append("photographer", $('#ph-input').prop("value"))

                        const returnPolicy = async () => {
                            let uploadReturnPolicy = await fetch("/cn/i/upload", {
                                method: "POST",
                                body: fd,
                                credentials: "same-origin"
                            })

                            return await uploadReturnPolicy.json();
                        }

                        const getReturn = async () => {
                            let jsonData = await returnPolicy();
                            window.location.href = jsonData.redirect
                        }

                        getReturn()
                    })


                });
            })

        </script>
    </head>
    <body>
        <div class="n pabs w-100 h-100 z-3 f jcc" id="overlay">
            <div class="w-50 b-1-do b-r-2 bg-light-orange prlt p-2 ffc">
                <label>
                    <input class="w-100 p-2 b-1-do b-r-1" type="text" placeholder="Photographer name" id="ph-input" required>
                </label>
                <button class="w-100 mt-2" id="submit-def">Upload</button>
            </div>
        </div>
        <div class="bg-dark-orange">
            <div th:replace="~{fragments/header :: header}"></div>
            <div id="hrepdiv" class="bg-transparent"></div>
        </div>
        <main>
            <div class="p-2 mt-5 w-100">
                <div class="w-75 m-a">
                    <form id="uploadForm">
                        <div id="dropzone" class="w-100 ib f tc aic jcc" style="border: 5px dashed var(--darkorange); border-radius: 2vh; height: 50vh">
                            <span id="selection">
                                Click to select a file
                            </span>
                        </div>
                        <input id="fileInput" class="n" type="file" accept="application/zip,image/jpeg,image/heic,image/heif,image/png,image/tiff,image/cr2">
                        <button class="w-100 mt-5" type="submit" id="submit">Submit</button>
                    </form>
                </div>
            </div>
        </main>

        <div th:replace="~{fragments/footer :: footer}"></div>

    </body>

</html>