<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>PicMan PicturEdit</title>
        <meta charset="utf-8">
        <meta name="author" content="Angelo">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" th:href="@{/css/styles.css}">
        <link rel="stylesheet" th:href="@{/css/footer.css}">
        <link rel="stylesheet" th:href="@{/css/header.css}">
        <link rel="shortcut icon" th:href="@{/imgs/logo.png}" type="image/x-icon">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1/dist/fancybox/fancybox.css">

        <script th:inline="javascript">
            /*      TAGS SEARCH     */
            $(document).ready(function () {
                let catsMap = [[${categories}]]
                let presentCats = [[${pictureCategories}]]

                let catsTemp = catsMap.map(i => {
                    return { name: i.name, id: i.id }
                })

                let cats = []
                catsTemp.forEach(function (i) {
                    if (!presentCats.some(k => k.name === i.name)) {
                        cats.push(i)
                    }
                })

                const res = $('#categories-results')
                const $input = $('input#categories-input')
                let tags = []

                function updateHidden() {
                    const tagsIds = []
                    Object.keys(tags).forEach(t => tagsIds.push(tags[t]["id"].toString()))
                    $('input#hidden-categories-input').val(tagsIds.join(','))
                }

                function checkValidAndAppend(text) {
                    const yieldedText = cats.filter(i=>{
                        return i["name"].toLowerCase().includes(text.toLowerCase())
                    })
                    if (yieldedText.length===1 && !tags.includes(yieldedText[0])) {
                        tags.push(yieldedText[0])
                        return yieldedText[0]
                    }
                }

                function createTag(text) {
                    if (!text) return;
                    const res = checkValidAndAppend(text)

                    if (!res) return;

                    let $tag = $('<span class="tag"></span>').text(res["name"]);
                    $tag.on('click', function () {
                        // remove tag on click
                        tags = tags.filter(t => t["name"] !== res["name"]);
                        $tag.remove();
                        updateHidden();
                    });

                    $tag.insertAfter($('#tagsDivBegin'))
                    if (tags.length === 0) {
                        $('#tagsDiv').addClass("vhdn")
                    } else $('#tagsDiv').removeClass("vhdn")
                    updateHidden()
                    $input.val('')
                    $input.focus()
                }

                function enterOrBackspace($input, e) {
                    if (e.key === 'Tab' || e.key === ',') {
                        e.preventDefault()
                        const v = $input.val().trim();
                        createTag(v)
                    } else if (e.key === 'Backspace' && $input.val() === '') {
                        const $lastTag = $('#tagsDiv').find('span.tag').first();
                        if ($lastTag.length) {
                            tags.pop()
                            if (tags.length === 0) $('#tagsDiv').addClass("vhdn")
                            $lastTag.remove()
                            updateHidden()
                        }
                    } else if (e.key === 'Enter' && $input.val() === '') {
                        if (tags.length !== 0) {
                            const fd = new FormData()
                            fd.append("pic-id", $("img.result-picture").attr("alt"))
                            fd.append("tag-id", $('input#hidden-categories-input').val())
                            fd.append("remove", "false")

                            const returnPolicy = async () => {
                                let uploadReturnPolicy = await fetch("/cn/i/tagedit", {
                                    method: "POST",
                                    body: fd,
                                    credentials: "same-origin"
                                })

                                return await uploadReturnPolicy.json();
                            }

                            const getReturn = async () => {
                                let jsonData = await returnPolicy();
                                window.location.href = jsonData.redirect
                            }

                            getReturn()

                        }
                    }
                }

                $input.keydown(function (e) {
                    if ($(this).val().length>1) {
                        res.removeClass("vhdn")
                    }
                    enterOrBackspace($(this), e)
                })

                $input.keyup(function () {
                    const inputval = $(this).val()
                    res.empty()
                    if (inputval.length > 1) {
                        res.removeClass("vhdn")
                        let filter = cats.filter(i => i["name"].toLowerCase().includes(inputval.toLowerCase()))
                        filter = filter.filter(i => !tags.includes(i))
                        if (filter.length===0) {
                            res.append('<p class="no-result">Nessun risultato</p>')
                        } else {
                            filter.forEach(f => {res.append('<p class="result" tabindex="' + (filter.indexOf(f)+1) + '">' + f["name"] + '</p>')})
                            $("p.result[tabindex='1']").attr("autofocus", "true")
                            // For future implementation of result navigability
                        }
                    } else {
                        res.addClass("vhdn")
                        $(this).removeClass('p-b-0')
                    }

                })
                $('div').on('click', '> p.result', function () {
                    $input.val($(this).text())
                    res.empty()
                    enterOrBackspace($input, {
                        key: 'Tab', preventDefault: () => {
                        }
                    })
                    $input.empty()
                    res.addClass("vhdn")
                })
            })
            $(document).ready(function () {
                $(".present-tag").on({
                    mouseenter: function () {
                        $("#" + this.id + " ~ .add-overlay").removeClass("vhdn").addClass("striped-overlay")
                    },
                    mouseleave: function () {
                        $("#" + this.id + " ~ .add-overlay").addClass("vhdn").removeClass("striped-overlay")
                    }
                })
            })
            $(document).ready(function () {
                const fd = new FormData()
                fd.append("pic-id", $("img.result-picture").attr("alt"))

                $("[id^=remove-]").on("click", function () {
                    fd.append("tag-id", this.id.split("-")[1])
                    fd.append("remove", "true")

                    const returnPolicy = async () => {
                        let uploadReturnPolicy = await fetch("/cn/i/tagedit", {
                            method: "POST",
                            body: fd,
                            credentials: "same-origin"
                        })

                        return await uploadReturnPolicy.json();
                    }

                    const getReturn = async () => {
                        let jsonData = await returnPolicy();
                        window.location.href = jsonData.redirect
                    }

                    getReturn()
                })
            })
        </script>
        <script>
            $(document).ready(function () {
                const className = "fa-regular";

                $("i[id$='-nav'].fa-circle").on("click", function () {
                    if (!this.classList.contains(className)) {
                        $("i.fa-circle.fa-regular").removeClass(className)
                        $(this).addClass(className)
                        const id = this.id.split("-")[0];
                        $("div[id$=-data]").addClass("vhdn")
                        $("div#" + id + "-data").removeClass("vhdn")
                    }
                })
            })
        </script>
    </head>
    <body>
        <div class="bg-dark-orange">
            <div th:replace="~{fragments/header :: header}"></div>
            <div id="hrepdiv" class="bg-transparent"></div>
        </div>
        <div class="main-spacer-5"></div>
        <main>
            <div class="p-2 w-100">
                <div class="w-100 ffr">
                    <div class="w-50">
                        <a th:href="|/images/${pic.getPath()}.${pic.getExt()}|">
                            <img data-fancybox="" style="height: 100%;" th:src="|/images/${pic.getPath()}.${pic.getExt()}|" th:alt="${pic.getId()}" class="w-100 result-picture">
                        </a>
                    </div>
                    <div class="w-50 ffc p-s-2">
                        <div class="w-100 tc"><p>PicMan image data</p></div>
                        <div class="w-100 ffr mt-5">
                            <div class="w-50 tb data">
                                <p>Image ID</p>
                                <p>Added on</p>
                                <p>Protected</p>
                            </div>
                            <div class="w-50 tb te data">
                                <p th:text="${pic.getId()}"></p>
                                <p th:text="${pic.getFormattedDate(pic.getDateadded())}"></p>
                                <p th:text="${pic.isProtection()}"></p>
                            </div>
                        </div>
                        <hr style="margin: 2vh 0;">
                        <div class="w-100" id="tags-data">
                            <div class="w-100">
                                <div class="w-100 tc"><p>Tags section</p></div>
                                <div class="ffr w-100 mt-5">

<!--                                    <div style="width: 90%;" class="tb ffc">
                                        <div class="w-100" id="search">
                                            <input id="categories-input" type="search" class="w-100 p-2" placeholder="Add a category...">
                                            <form id="tagsForm" method="get" class="vhdn">
                                                <input id="hidden-categories-input" name="hidden-tags" type="hidden" class="vhdn" value="">
                                            </form>
                                            <div id="categories-results" class="w-100 p-s-1-im p-b-1 vhdn"></div>
                                            <div id="tagsDiv" class="p-s-2 p-b-1 vhdn"><i id="tagsDivBegin"></i></div>
                                        </div>
                                    </div>
                                    <div class="bg-dark-orange f b-r-2 aic jcc" style="width: 10%;margin-left: 2%">
                                        <i class="fa fa-plus tw"></i>
                                    </div>-->

                                    <div class="tb w-100">
                                        <div class="w-100" id="search">
                                            <input id="categories-input" type="search" class="w-100 p-2" placeholder="Add a category...">
                                            <form id="tagsForm" method="get" class="vhdn">
                                                <input id="hidden-categories-input" name="hidden-tags" th:name="hidden-tags" type="hidden" class="vhdn">
                                            </form>
                                            <div id="categories-results" class="w-100 vhdn p-s-1-im p-b-1"></div>
                                            <div id="tagsDiv" class="p-s-2 p-b-1 vhdn"><i id="tagsDivBegin"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-100 ffc mt-5">
                                    <div class="w-100 ffr fw tw">
                                        <div th:if="${pictureCategories.size()}!=0" th:each="pc, i: ${pictureCategories}" class="f tag-edit aic bg-dark-orange b-r-1 prlt" style="border: 1px solid black">
                                            <span class="z-3 present-tag" th:id="|remove-${pc.getId()}|" th:text="${pc.getName()}"></span>
                                            <div class="vhdn pabs w-100 h-100 add-overlay"></div>
                                        </div>
                                        <div th:unless="${pictureCategories.size()}!=0" class="tb w-100 tc"><p>No tags for this picture</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="w-100 vhdn" id="technical-data">
                            <div class="w-100 tc"><p>Image metadata</p></div>
                            <div class="w-100 ffr mt-5">
                                <div class="w-50 tb data">
                                    <p>Size</p>
                                    <p>Shot on</p>
                                    <p>Height</p>
                                    <p>Width</p>
                                    <p>Aperture</p>
                                    <p>Exposure time</p>
                                    <p>ISO speed</p>
                                    <p>Focal length</p>
                                    <p>Camera model</p>
                                    <p>Photographer</p>
                                </div>
                                <div class="w-50 tb te data">
                                    <p th:text="${pic.getSizekb() != null ? pic.getSizekb() + ' KB' : 'No data'}"></p>
                                    <p th:text="${pic.getFormattedDate(pic.getShotat()) ?: 'No data'}"></p>
                                    <p th:text="${pic.getHeight() != null ? pic.getHeight() + ' px' : 'No data'}"></p>
                                    <p th:text="${pic.getWidth() != null ? pic.getWidth() + ' px' : 'No data'}"></p>
                                    <p th:text="${pic.getAperture() ?: 'No data'}"></p>
                                    <p th:if="${pic.getExposureden()!=1}" th:text="${(pic.getExposurenum() != null && pic.getExposureden() != null) ? pic.getExposurenum()+'/'+pic.getExposureden()+'s' : 'No data'}"></p>
                                    <p th:unless="${pic.getExposureden()!=1}" th:text="${(pic.getExposurenum() != null && pic.getExposureden() != null) ? pic.getExposurenum()+'s' : 'No data'}"></p>
                                    <p th:text="${pic.getIso() ?: 'No data'}"></p>
                                    <p th:text="${pic.getFocallength() != null ? pic.getFocallength() + ' mm' : 'No data'}"></p>
                                    <p th:text="${pic.getCameramodel() ?: 'No data'}"></p>
                                    <p th:text="${pic.getPhotographer() ?: 'No data'}"></p>
                                </div>
                            </div>
                        </div>
                        <div class="w-100 f jcc mt-a">
                            <i class="fa fa-circle fa-regular" id="tags-nav"></i>
                            <i class="fa fa-circle" id="technical-nav"></i>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        <div class="main-spacer-5"></div>
        <div th:replace="~{fragments/footer :: footer}"></div>

        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.1/dist/fancybox/fancybox.umd.js"></script>
        <script>
            Fancybox.bind("[data-fancybox]", {
                Carousel: {
                    Toolbar: {
                        display: {
                            left: ["counter"],
                            middle: [
                                "zoomIn",
                                "zoomOut",
                                //"toggle1to1",
                                //"rotateCCW",
                                //"rotateCW",
                                //"flipX",
                                //"flipY",
                                //"reset",
                            ],
                            right: ["autoplay", "thumbs", "close"],
                        },
                    },
                },
            });
        </script>
    </body>
</html>